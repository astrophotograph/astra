name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (CalVer, e.g. 2026.2.0). Leave empty to auto-increment."
        required: false
        type: string

permissions:
  contents: write

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Calculate version
        id: version
        run: |
          CURRENT=$(grep '"version"' package.json | head -1 | sed 's/.*"\([0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\)".*/\1/')
          echo "Current version: $CURRENT"

          if [[ -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
          else
            IFS='.' read -r CUR_YEAR CUR_MONTH CUR_MICRO <<< "$CURRENT"
            NOW_YEAR=$(date +%Y)
            NOW_MONTH=$(date +%-m)

            if [[ "$CUR_YEAR" == "$NOW_YEAR" && "$CUR_MONTH" == "$NOW_MONTH" ]]; then
              NEW_MICRO=$((CUR_MICRO + 1))
              VERSION="${NOW_YEAR}.${NOW_MONTH}.${NEW_MICRO}"
            else
              VERSION="${NOW_YEAR}.${NOW_MONTH}.0"
            fi
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release version: $VERSION"

  build-tauri:
    name: Build (${{ matrix.platform }})
    needs: determine-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          # Uncomment when ready to support more platforms:
          # - platform: macos-latest
          #   target: aarch64-apple-darwin
          # - platform: macos-13
          #   target: x86_64-apple-darwin
          # - platform: windows-latest
          #   target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Update version in source files
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Cargo.toml
          sed -i "0,/^version = \".*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

          # tauri.conf.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json

          # pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" python/pyproject.toml

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            python3-dev

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - run: pnpm install --frozen-lockfile

      - name: Build Tauri app
        run: pnpm tauri build --target ${{ matrix.target }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/rpm/*.rpm
            src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
          if-no-files-found: ignore

  publish-release:
    name: Create GitHub Release
    needs: [determine-version, build-tauri]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f 2>/dev/null || echo "No artifacts found"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # Collect all release assets
          ASSETS=""
          for f in $(find artifacts -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.dmg" -o -name "*.exe" \) 2>/dev/null); do
            ASSETS="$ASSETS $f"
          done

          gh release create "v${VERSION}" \
            --title "Astra ${VERSION}" \
            --generate-notes \
            $ASSETS
